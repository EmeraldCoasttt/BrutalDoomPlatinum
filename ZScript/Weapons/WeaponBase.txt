class GunfireParticle : VisualThinker
{
	override void PostBeginPlay()
	{
		Super.PostBeginPlay();
		texture = TexMan.CheckForTexture('SPKOB0');
		scale = (0.1,0.1);
		alpha = 1;
		flags = SPF_FULLBRIGHT;
		SetRenderStyle(STYLE_Add);
		pos += vel/2;
	}
	
	override void Tick()
	{
		if(alpha <= 0)
		{
			Destroy();
		}
		vel.z -= 0.6;
		alpha -= 0.04;
		Super.Tick();
	}
}

Class Brutalweapon : DoomWeapon //Weapon
{
	bool noSpecial;
	int aimMode;
	statelabel aimDest;
	bool scopeZoom;
	
	bool dualWield;
	bool initDual;
	bool switchingDual;
	bool sideFired;
	name dualWeapon;
	property DualWeapon : dualWeapon;

	int sprinttimer;
	int Weight; 
	property Weight : Weight;
	int Handedness; 
	property Handedness : Handedness;
	bool lasttickfatality;
	Bool offhandkick;
	Property offhandkick : offhandkick;
	Bool clearoverlays;
	Property clearoverlays : clearoverlays;
	Bool VoiceActed;
	Property VoiceActed : VoiceActed;
	
	bool semiautofired;
	bool semiclear;
	bool refireq;
	
	bool dryFired;
	
	Actor GuidedLaser;
	
	//Modifiers:
	bool gunslinger;
	int gunslingertics;
	bool gunslingereligible;
	bool gunslinger2;
	
	//name gunslingerammoname;
	name gunslingermagname;
	int gunslingermagsize;
	
	name AmmoType3;
	Property AmmoType3 : AmmoType3;
	
	int mag;
	int MagCapacity;
	Property MagCapacity : MagCapacity;
	vector2 magConversion;
	Property MagConversion : magConversion;
	
	bool newweapon;
	
	bool showicon;
	Property showicon : showicon;
	
	bool ForceSelect;
	Property ForceSelect : ForceSelect;
	
	Default
	{
	BrutalWeapon.Weight 1;
	BrutalWeapon.Handedness 0;
	Weapon.AmmoUse 0;
	Weapon.BobRangeX 0.4;
	Weapon.BobRangeY 0.4;
	Weapon.BobSpeed 2.9;
	Weapon.BobStyle "InverseAlpha";
	brutalweapon.clearoverlays TRUE;
	brutalweapon.VoiceActed TRUE;
	//Radius 32;
	+FORCEXYBILLBOARD
	+WEAPON.NOAUTOAIM
	+WEAPON.NOAUTOFIRE
	+WEAPON.NOALERT
	+NOBLOOD
	}
	
	override void beginplay()
	{
		mag = magcapacity;
		if(magConversion == (0,0))
		{
			magConversion = (1,1);
		}
		Super.beginplay();
	}
	
	override void ondrop(Actor dropper)
	{
		giveinventory("AmmoTaken",1);
		
		If(self is "BDPSubmachineGun")
		{
			If(dropper.findinventory("BDPDualSMG"))
			{
				giveinventory("BDPSubmachineGun",1);
				Inventory drop = FindInventory("BDPSubmachineGun");
				Self.DropInventory(Drop,1);
			}
			
			Dropper.takeinventory("BDPDualSMG",1);
		}
		If(self is "BDPRevolver")
		{
			If(dropper.findinventory("BDPDualRevolver"))
			{
				giveinventory("BDPRevolver",1);
				Inventory drop = FindInventory("BDPRevolver");
				Self.DropInventory(Drop,1);
			}
			
			Dropper.takeinventory("BDPDualRevolver",1);
		}
		If(self is "BDPPlasmaRifle")
		{
			If(dropper.findinventory("BDPDualPlasmaRifle"))
			{
				giveinventory("BDPPlasmaRifle",1);
				Inventory drop = FindInventory("BDPPlasmaRifle");
				Self.DropInventory(Drop,1);
			}
			
			Dropper.takeinventory("BDPDualPlasmaRifle",1);
		}
		
	}
	
	override state GetUpState()
	{
		return resolvestate("InitWeaponState");
	}
	
	Action void a_weaponvoiceline()
	{
		If(!invoker.newweapon && invoker.voiceacted)
		{
			let dplr = Brutal_PlayerBase(invoker.owner);
			if(dplr)
			{
				dplr.newweapon = true;
			}
			invoker.newweapon = true;
		}
	
	}
	
	Action void a_discardmag(string magname, int plusone)
	{
		
			let dplr = Brutal_PlayerBase(invoker.owner);
			if(dplr && dplr.gluttony)
			{
				Until(dplr.countinv(magname) <= plusone)
				{
					dplr.takeinventory(magname,1);
				}
			}
		
	
	}
	
	Action void a_discardmagazine(int plusone = 0)
	{
		
			let dplr = Brutal_PlayerBase(invoker.owner);
			if(dplr && dplr.gluttony)
			{
				Until(invoker.mag <= plusone)
				{
					invoker.mag--;
				}
			}
		
	
	}
	
	Action void A_SetCrosshairDX(string crosshairname, int crosshairrange = 5000, double crosshairscale = 1.0)
	{
		let dplr = Brutal_PlayerBase(invoker.owner);
			if(dplr)
			{
				dplr.crosshair = crosshairname;
				dplr.crosshairscale = (crosshairscale,crosshairscale);
				dplr.crosshairrange = crosshairrange;
			}
	
	}
	
	Action void A_QuadSound()
	{	
		If(invoker.owner.findinventory("PowerQuakeDamage"))
		{
			invoker.owner.a_startsound("items/quaddamage/active", 103);
		}
	}
	
	Action void A_FirePitchDown(sound soundname = "PLSM9", int soundchannel = 1, double ammocount = 8, name ammotype = "PlasmaAmmo")
	{
		If(invoker.mag > ammocount)
		{
			invoker.owner.a_startsound(soundname,soundchannel);
		}
		Else
		{
			float soundpitch;
			soundpitch = (invoker.mag / (ammocount * 5));
			soundpitch = (0.8 + soundpitch);
			
			invoker.owner.a_startsound(soundname,soundchannel, PITCH: soundpitch);
		}
	}
	
	int guntimertics;
	Action void A_GunLight(int intensity = 500, int alivetime = 2, int lightr = 255, int lightg = 237, int lightb = 162)
	{
		if(getcvar("BDP_GunLight") == true)
		{
			BDP_Gunlight SelfLight1 = BDP_Gunlight(Spawn("BDP_Gunlight",(invoker.owner.pos.x, invoker.owner.pos.y, invoker.owner.pos.z + invoker.owner.player.viewheight),false));
			SelfLight1.args[DynamicLight.LIGHT_RED] = lightr; //R
			SelfLight1.args[DynamicLight.LIGHT_GREEN] = lightg; //G
			SelfLight1.args[DynamicLight.LIGHT_BLUE] = lightb; //B
			SelfLight1.args[DynamicLight.LIGHT_INTENSITY] = intensity; //Intensity
			SelfLight1.SpotInnerAngle = 60;
			SelfLight1.SpotOuterAngle = 90;
			SelfLight1.angle = invoker.owner.angle;
			SelfLight1.pitch = invoker.owner.pitch;
			SelfLight1.alivetime = alivetime;
		}
	}
	
	//Lewisk3 :3
	
	action Actor A_BDPMelee(double range = 200, name projectile = "MeleeAttack", double spawnheight = -7, bool doHitThrust = true)
	{
		Actor Victim;
		
			FLineTraceData lt;
			double aimz = self.player ? self.player.viewheight : (self.height * 0.5);
			self.LineTrace(self.angle, range, self.pitch, 0, aimz, data:lt);
			victim = lt.HitActor;
			int aimCheck = -6;
			bool backsmack;
		
		
			while (aimCheck++ < 6 && !victim)
			{
				self.LineTrace(self.angle + (aimCheck * 8), range, self.pitch, 0, aimz, data:lt);
			victim = lt.hitActor;
			}
			
			
		
			
		
		if(victim && victim.bSHOOTABLE) 
		{
			
			vector3 victimAngles = level.sphericalCoords(victim.pos, self.pos, (victim.angle, victim.pitch));
			

			
			double inertia = BDPMath.GetInertia(victim.mass);
			self.A_Quake(2,3,0,20,"");
			self.A_face(victim);
			if(doHitThrust && victim.bsolid)
			{
				self.vel *= 0;
				self.vel += BDPMath.VecFromAngles(self.angle, self.pitch, -12);	
			}
						
		}
		actor proj = A_FireProjectile(projectile, 0, 0, 0, spawnheight);
			If(proj && victim && victim.bSHOOTABLE)
			{
				proj.setorigin(victim.pos,false);
			}
		
		return victim;
	}
	
	action void A_Reload(name mag, int magsize, name ammopool, int chamberbonus = 0, int conversion = 1, name secondarymag = "", int secondarymagsize = 0, int secondarychamberbonus = 0, bool multiplicative = false)
	{
		Int MagGoal;
		If(countinv(mag) > 0)
		{
			MagGoal = (magsize + chamberbonus);
		}
		Else
		{
			MagGoal = magsize;
		}
		Int SecondaryMagGoal;
		If(countinv(secondarymag) > 0)
		{
			SecondaryMagGoal = (secondarymagsize + secondarychamberbonus);
		}
		Else
		{
			SecondaryMagGoal = secondarymagsize;
		}
		
		Bool Reloaded;
		
		While(!reloaded)
		{
			If(countinv(mag) < MagGoal && countinv(ammopool) >= conversion && !multiplicative)
			{
				takeinventory(ammopool,conversion);
				giveinventory(mag,1);
				If(secondarymag && countinv(secondarymag) < SecondaryMagGoal)
				{
					giveinventory(secondarymag,1);
				}
			}
			Else If(countinv(mag) < MagGoal && multiplicative && countinv(ammopool) >= 1)
			{
				takeinventory(ammopool,1);
				giveinventory(mag,conversion);
				If(secondarymag && countinv(secondarymag) < SecondaryMagGoal)
				{
					giveinventory(secondarymag,conversion);
				}
			}
			else
			{
				reloaded = TRUE;
			}
		}
	}
	
	action void A_ReloadMag(int chamberbonus = 0, bool additive = false, bool free = false)
	{
		int MagGoal = invoker.MagCapacity;
		if(additive)
		{
			MagGoal = invoker.mag + invoker.magConversion.x;
		}
		int SecondaryMagGoal;
		if(invoker.mag > 0)
		{
			MagGoal += chamberbonus;
		}
		while(invoker.mag < MagGoal && countinv(invoker.AmmoType1) >= invoker.magConversion.y)
		{
			if(!free)
			{
				takeinventory(invoker.AmmoType1,invoker.magConversion.y);
			}
			invoker.mag += invoker.magConversion.x;
			invoker.mag = clamp(invoker.mag,0,MagGoal);
			//If(secondarymag && countinv(secondarymag) < SecondaryMagGoal)
			//{
			//	giveinventory(secondarymag,1);
			//}
		}
	}
	
	
	
	Action void A_gunslingerreload(name mag, int magsize, name ammopool, int conversion = 1, name secondarymag = "null")
	{	
		//Functionality dummied out for refactoring
		/*
		If(invoker.gunslinger && invoker.gunslingereligible)
		{
			A_reload(mag, magsize, ammopool, 0, conversion, secondarymag);
		}
		invoker.gunslingereligible = false;
		//Invoker.gunslingerammoname = ammopool;
		Invoker.gunslingermagname = mag;
		Invoker.gunslingermagsize = magsize;
		*/
	}
	
	Action void A_gunslingermag(int chamberbonus = 0)
	{
		If(invoker.gunslinger && invoker.gunslingereligible)
		{
			A_reloadMag(chamberbonus);
		}
		invoker.gunslingereligible = false;
		//Invoker.gunslingerammoname = ammopool;
	}
	
	
	
	Action void A_BDPMeleeStart(double range = 200)
	{
	//if(A_CheckMeleeRange(skipWalls:true) < range) A_Recoil3D(-20); 
		FLineTraceData lt;
			LineTrace(angle, range, pitch, 0, player.viewheight, data:lt);
			If(lt.hitactor && lt.hitactor.bsolid)
			{
				A_face(lt.hitactor,0,0,0,0,FAF_MIDDLE);
				A_Recoil3D(-20);
				
			}
		
		
		
	}
	
	action double A_CheckMeleeRange(double maxrange = 512, bool skipWalls = false)
	{
		FLineTraceData lt;
		LineTrace(angle, maxrange, pitch, 0, player.viewheight, data:lt);
		return (skipWalls && !lt.hitActor) ? maxrange : lt.Distance;
	}
	
	action void A_Recoil3D(double amt)
	{
		vel += BDPMath.VecFromAngles(angle, pitch, -amt);	
	}
	
	action state A_CheckFire(statelabel Fire = "Fire", statelabel AltFire = "AltFire")
	{
		If(player.cmd.buttons & BT_ATTACK)
		{
			return resolvestate(fire);
		}
		Else if (player.cmd.buttons & BT_ALTATTACK)
		{
			return resolvestate(altfire);
		}
		Else 
		{
			return resolvestate(null);
		}
	
	
	}
	
	
	//Is BT_Reload cursed? Why doesn't it register the input?
	//I feel like I'm going insane
	//Emerald 11/7/2025
	
	//Oh my god it was just brutal doom jank FUCK
	action state A_PressingReload(statelabel reloadstate = "reload")
	{
		if ((player.cmd.buttons & BT_RELOAD) || (player.oldbuttons & BT_RELOAD))
		{
			//console.printf("YeeHaw");
			return resolvestate(reloadstate);
		}
		Else 
		{
			return resolvestate(null);
		}
	
	
	}
	
	Action void a_SpawnLaser(class<Actor> Spawntype)
	{
		FLineTraceData lasersight;
		invoker.owner.LineTrace(invoker.owner.angle, 4096, invoker.owner.pitch, TRF_SOLIDACTORS|TRF_THRUHITSCAN, offsetz: invoker.owner.player.viewz - invoker.owner.pos.z, data: lasersight);
		vector3 targetpos = lasersight.HitLocation;
		if (lasersight.HitLine)
		{
			vector2 wallnormal = (-lasersight.HitLine.delta.y,lasersight.HitLine.delta.x).unit();
			if (!lasersight.LineSide)
			wallnormal *= -1;
			targetpos += (wallnormal * 18);
		}
		/*
		if (lasersight.hittype == trace_hitceiling)
				{
					targetpos.z -= 2;
				}
		if (lasersight.hittype == trace_hitfloor)
				{
					targetpos.z += 2;
				}
				*/
		Spawn(spawntype,targetpos);
	
	}
	
	Action void a_TakeAmmo(class<Inventory> ammotype, int ammoamount = 1, bool take = true)
	{
		If(!findinventory("PowerSpeed2") && take)
		{
			A_takeinventory(ammotype,ammoamount);
		}
		Else if(!findinventory("powerspeed2"))
		{
			A_giveinventory(ammotype,ammoamount);
		}
	}
	
	Action void a_TakeMag(int ammoamount = 1, bool take = true, bool force = false)
	{
		If((!findinventory("powerspeed2") || force) && take)
		{
			invoker.mag -= ammoamount;
		}
		Else if(!findinventory("powerspeed2") || force)
		{
			invoker.mag += ammoamount;
		}
	}
	
	action state A_StartAim(statelabel aim = 'Aim')
	{
		if((player.cmd.buttons & BT_ALTATTACK && getcvar("bd_Aim") == 0) || getcvar("bd_Aim") == 2)
		{
			invoker.aimMode = 2;
		}
		else
		{
			invoker.aimMode = 1;
		}
		TakeInventory("StartDualWield",1);
		return resolvestate(aim);
	}
	
	action state A_ReadyAim(bool allowreload = false, bool scoped = false, double lowfactor = 3.0, double highfactor = 9.0, string insound = "ADSIN", string outsound = "ADSOUT", statelabel end = 'AimEnd', statelabel fire = 'FireAim')
	{
		DoReadyWeaponToBob(player);
		if(player.PendingWeapon != WP_NOCHANGE)
		{
			invoker.aimDest = 'Deselect';
		}
		else if(player.cmd.buttons & BT_ATTACK && (!invoker.semiautofired || invoker.semiclear))
		{
			return resolvestate(fire);
		}
		else if((invoker.aimMode == 2 && !(player.cmd.buttons & BT_ALTATTACK)) || (invoker.aimMode == 1 && JustPressed(BT_ALTATTACK) && (scoped == false || (scoped == true && invoker.scopeZoom == true))))
		{
			invoker.aimDest = 'Ready';
		}
		else if(player.cmd.buttons & BT_RELOAD && invoker.mag < invoker.magCapacity)
		{
			if(CountInv(invoker.ammotype1) >= invoker.magConversion.y)
			{
				invoker.aimDest = 'Reload';
			}
			else
			{
				return resolvestate("NoAmmo");
			}
		}
		else if(player.cmd.buttons & BT_USER2)
		{
			invoker.aimDest = 'User2';
		}
		else if(player.cmd.buttons & BT_USER3 && !scoped)
		{
			if(!invoker.noSpecial)
			{
				invoker.aimDest = 'SpecialAction';
			}
		}
		else if(player.cmd.buttons & BT_USER4)
		{
			invoker.aimDest = 'User4';
		}
		else
		{
			invoker.noSpecial = false;
			invoker.aimDest = null;
		}
		if(scoped == true)
		{
			if(((JustPressed(BT_ALTATTACK) && invoker.aimMode == 1) || (player.cmd.buttons & BT_USER3 && !(player.oldbuttons & BT_USER3) && invoker.aimMode == 2)) && invoker.scopeZoom == false)
			{
				A_StartSound(insound);
				invoker.scopeZoom = true;
				A_ZoomFactor(highfactor);
			}
			else if(player.cmd.buttons & BT_USER3 && !(player.oldbuttons & BT_USER3) && invoker.aimMode == 2 && invoker.scopeZoom == true)
			{
				A_StartSound(outsound);
				invoker.scopeZoom = false;
				A_ZoomFactor(lowfactor);
			}
			TakeInventory("StartDualWield",1);
		}
		if(invoker.aimDest)
		{
			return resolvestate(end);
		}
		else
		{
			return resolvestate(null);
		}
	}
	
	action state A_EndAim()
	{
		invoker.aimMode = 0;
		invoker.scopeZoom = false;
		return resolvestate(invoker.aimDest);
	}
	
	action void SetFired(bool number) //todo: remove when we stop using decorate for weapons
	{
		invoker.sideFired = number;
	}
	
	action bool GetFired() //ditto
	{
		return invoker.sideFired;
	}
	
	action int GetAim() //ditto
	{
		return invoker.aimMode;
	}
	
	action bool GetPressed(int which) //ditto
	{
		return player.cmd.buttons & which;
	}
	
	action void SetAimDest(statelabel dest) //ditto
	{
		invoker.aimDest = dest;
	}
	/*action void A_GetSawSprites() //"PowerBloodOnVisor" "PowerBlueBloodOnVisor" "PowerGreenBloodOnVisor"
	{
		string cursprite = TexMan.GetName(player.FindPSprite(1).curstate.GetSpriteTexture(0));'
		if(cursprite != "TNT1A0")
		{
		string sprname = cursprite.Mid(1,3);
		A_Print(cursprite);
		A_Print(sprname);
			if(CountInv("PowerBloodOnVisor") > 0)
			{
				player.FindPSprite(1).sprite = GetSpriteIndex("1"..sprname);
				string fuck = TexMan.GetName(player.FindPSprite(1).curstate.GetSpriteTexture(0));
				A_Print(fuck);
			}
		}
	}*/
			
	action void A_FireVThinker(class<VisualThinker> thinker, int speed = 0, double angle = 0, double pitch = 0, double offsetx = 0, double offsetz = 0, bool relativevelocity = false)
	{
		let thonk = Level.SpawnVisualThinker(thinker);
		if(thonk)
		{
			thonk.pos = player.mo.pos;
			thonk.pos.xy += AngleToVector(player.mo.angle - 90, offsetx);
			thonk.pos.z += player.mo.height * 0.5 - player.mo.floorclip + player.mo.AttackZOffset*player.crouchFactor - 4 + offsetz; //i want to die
			invoker.Vel3DFromAngle(speed,player.mo.angle + angle,player.mo.pitch + pitch);
			thonk.vel = invoker.vel;
			invoker.Vel3DFromAngle(clamp(speed/2,0,player.mo.radius),player.mo.angle + angle,player.mo.pitch + pitch);
			thonk.pos += invoker.vel;
			if(relativevelocity)
			{
				thonk.vel += player.mo.vel;
			}
		}
	}
	
	action void A_FireParticles(int number = 1, int spread = 12, int offsetx = 0, int offsetz = 0)
	{
		for(int i = number; i > 0; i--)
		{
			A_FireVThinker("GunfireParticle",random(10,15),random(-spread,spread),random(-9,9),offsetx,offsetz);
		}
	}
	
	action state A_CheckSlide(statelabel end = "SlideKickingEnd")
	{
		if (CountInv("Kicking") == 0)
		{
			return resolvestate(end);
		}
		return resolvestate(null);
	}
	
	action state A_DualWield()
	{
		if(CountInv(invoker.GetClassName()) > 1)
		{
			GiveInventory(invoker.DualWeapon,1);
			invoker.dualWield = true;
			invoker.initDual = true;
			A_SelectWeapon(invoker.DualWeapon);
			BrutalWeapon nextWeapon = BrutalWeapon(player.PendingWeapon);
			if(nextWeapon)
			{
				nextWeapon.switchingDual = true;
			}
			return resolvestate("InstaDeselect");
		}
		A_Print("You must have two "..invoker.GetTag().."s to Dual wield!",3);
		return resolvestate("Ready");
	}
	
	action state A_EndDual()
	{
		A_SelectWeapon(invoker.DualWeapon);
		BrutalWeapon nextWeapon = BrutalWeapon(player.PendingWeapon);
		if(nextWeapon)
		{
			nextWeapon.dualWield = false;
			nextWeapon.switchingDual = true;
		}
		return resolvestate("InstaDeselect");
	}
	
	action state A_CheckIfAmmo(class<Inventory> ammotype, int ammoamount = 1, statelabel label = "NoAmmo")
	{
		If(countinv(ammotype) >= ammoamount || findinventory("PowerSpeed2"))
		{
		Return ResolveState(null);
		}
		Else
		{
		Return resolvestate(label);
		}
	}
	
	
	Action state A_JumpIfMagFull(statelabel label)
	{
		If(invoker.mag >= invoker.MagCapacity)
		{
		Return ResolveState(label);
		}
		Else
		{
		Return resolvestate(null);
		}
	}
	
	action state A_CheckIfMag(int ammoamount = 1, statelabel label = "NoAmmo", bool force = false)
	{
		If(invoker.mag >= ammoamount || (findinventory("PowerSpeed2") && !force))
		{
		Return ResolveState(null);
		}
		Else
		{
		Return resolvestate(label);
		}
	}
	
	action void A_trymeathook(int meathookrange = 256)
	{
	BlockThingsIterator CheckForTargets = BlockThingsIterator.create(Self,meathookrange); //256 can be whatever range around the actor.
Actor CurrentActor; //A pointer to whatever actor the iterator is iterating through.
	If(countinv("meathook") > 0)
	{
	While (CheckForTargets.Next() && countinv("meathook") > 0) 
{
    CurrentActor = CheckForTargets.Thing;
    //If the actor is a monster, has none of the specified item, the caller has a line of sight to the actor, and the actor is within 512 MU, then jump to the see state.
    //Itemname obviously has to be whatever item you want the actor to check that the possible target has none of, and the 512 map unit sight range can be changed to anything else.
    If ((CurrentActor && CurrentActor.bIsMonster && currentactor.bshootable && !currentactor.bfriendly && !currentactor.findinventory("isplayer") && CheckSight(CurrentActor,SF_IGNOREWATERBOUNDARY) && !(currentactor is "ExplosiveBarrel1")) || (currentactor && CheckSight(CurrentActor,SF_IGNOREWATERBOUNDARY) && currentactor.findinventory("isplayer") && currentactor != self))
    {
        target = currentactor;
		If(target)
		{
		
		
		
		vector3 targetpos = LevelLocals.SphericalCoords((pos.x,pos.y,player.viewz),target.pos+(0,0,target.default.height*0.5),(angle,pitch));    
		if (abs(targetpos.x) <= 20 && abs(targetpos.y) <= 20)
			{
  //this will execute only if the Other actor's center is within 25 degrees from the center of the player's screet
	
		//A_customrailgun(8,0,"","",RGF_SILENT|RGF_NOPIERCING,1,20,"bfgpuff",0,0,0,0,1.0,1,"none",-10);
		
		A_spawnprojectile("hook",32);
		A_takeinventory("meathook",1);
		//A_fireprojectile("")
		//A_takeinventory("meathook",1);
		a_startsound("MHKSTRT",193,CHANF_DEFAULT,1,ATTN_NONE);
		}
		//Else A_cleartarget();
		}
		
		
		
		
    }
	If (!target)
	{
	a_startsound("weapons/empty",190,CHANF_DEFAULT,1,ATTN_NONE);
	}
	//A_cleartarget();
}
	}
	
	
	
	
	Else
	{
	a_startsound("weapons/empty",193,CHANF_DEFAULT,1,ATTN_NONE);
	}
	
	
	
	}
	
	
	//action void A_UnmakeLevel(int times=1){brutalweapon.UnmakeLevel(times);}
	Action void A_UnmakeLevel(int times=1){
	
		for(int k=0;k<times;k++){
		Bool foundsector;
		Until(foundsector)
		{
			
			sector thissector=level.sectors[random(0,level.sectors.size()-1)];
			Vector3 sectorlocation;
			Sectorlocation.x = thissector.centerspot.x;
			Sectorlocation.y = thissector.centerspot.y;
			sectorlocation.z = thissector.floorplane.ZAtPoint(thissector.centerspot);
			If(LevelLocals.Vec3Diff(invoker.owner.pos, sectorlocation).Length() <= 700)
			{
				foundsector = true;
				int dir=random(-3,3);
				double zatpoint=thissector.floorplane.ZAtPoint(thissector.centerspot);
				thissector.MoveFloor(dir,zatpoint,0,zatpoint>0?-1:1,false);
				dir=random(-3,3);
				zatpoint=thissector.ceilingplane.ZAtPoint(thissector.centerspot);
				thissector.MoveCeiling(dir,zatpoint,0,zatpoint>0?-1:1,false);
				thissector.changelightlevel(random(-random(3,4),3));
				//then maybe add some textures
				textureid shwal;
				switch(random(0,4)){
				case 1:
					shwal=texman.checkfortexture("WALL63_2",texman.type_any);break;
				case 2:
					shwal=texman.checkfortexture("W94_1",texman.type_any);break;
				case 3:
					shwal=texman.checkfortexture("FIREBLU1",texman.type_any);break;
				case 4:
					shwal=texman.checkfortexture("SNAK"..random(7,8).."_1",texman.type_any);break;
				default:
					shwal=texman.checkfortexture("ASHWALL2",texman.type_any);break;
			}
			for(int i=0;i<thissector.lines.size();i++){
				line lnn=thissector.lines[i];
				for(int j=0;j<2;j++){
					if(!lnn.sidedef[j])continue;
					if(!lnn.sidedef[j].GetTexture(side.top))lnn.sidedef[j].SetTexture(side.top,shwal);
					if(!lnn.sidedef[j].GetTexture(side.bottom))lnn.sidedef[j].SetTexture(side.bottom,shwal);
				}
			}
			}
		}
		Foundsector = false;
		}
	}
	
	
	
	Action Bool A_PressedReload()
	{
		If(countinv("reloading") > 0 || player.cmd.buttons & BT_RELOAD)
			Return TRUE;
		Else
			Return FALSE;
	}
	
	
	
	
	action state A_OverlayFadeOut(double value)
		{
		let psp = Player.FindPSprite(OverlayID());
		if (!psp)
			return ResolveState(null);
		A_OverlayFlags(OverlayID(), PSPF_ALPHA|PSPF_FORCEALPHA, true);
		psp.alpha -= value;
		if (psp.alpha <= 0)
			return ResolveState("Null"); //destroy the layer
			return ResolveState(null);
		}
		
	Action void a_takefatalitystuff()
	{
	A_takeinventory("hasagib",666);
	A_takeinventory("hascacoeye",666);
	A_takeinventory("lostsoulfatality",666);
	A_takeinventory("hasbarrel",666);
	A_takeinventory("shotgunguyhead",666);
	A_takeinventory("hasimpfatality",666);
	}
	
	Action state A_AutoReload(Name Magtype, Name Ammotype, statelabel label = "Reload", bool force = false)
	{
		//FORCE flag is intended for single shot weapons
		If(countinv(Magtype) == 0 && countinv(Ammotype) > 0 && (invoker.owner.getcvar("bdp_autoreload") == true || force == true))
		{
			Return Resolvestate(Label);
		}
		Else
		{
			Return Resolvestate(Null);
		}
	
	}
	
	Action state A_AutoReloadMag(int minammo = 1, statelabel label = "Reload", bool force = false)
	{
		//FORCE flag is intended for single shot weapons
		If(invoker.mag < 1 && countinv(invoker.ammotype1) >= invoker.magConversion.y && (invoker.owner.getcvar("bdp_autoreload") == true || force == true))
		{
			if(invoker.aimMode == 0)
			{
				Return Resolvestate(Label);
			}
			else
			{
				invoker.aimDest = Label;
				return resolvestate("AimEnd");
			}
		}
		Else
		{
			Return Resolvestate(Null);
		}
	
	}
	
	Action state A_WeaponReadyDX(int dxflags = 0, bool kickflashes = true, bool cansprint = true, bool forcereload = false)
		{
			brutal_playerbase BDPplr = brutal_playerbase(invoker.owner);
			bool canreload = false;
			if(dxflags & WRF_ALLOWRELOAD)
			{
				canreload = true;
			}
			dxflags &= ~WRF_ALLOWRELOAD;
			dxflags |= WRF_ALLOWUSER4;
			//A_WeaponReadyDX acts as a wrapper for A_weaponready and accepts the same flags
			A_weaponready(dxflags);
			if(player.cmd.buttons & BT_RELOAD && canreload)
			{
				if(forcereload)
				{
					return resolvestate("Reload");
				}
				if(invoker.mag >= invoker.magCapacity)
				{
					if(resolvestate("Fidget")) return resolvestate("Fidget");
				}
				else if(CountInv(invoker.ammotype1) < invoker.magConversion.y)
				{
					return resolvestate("NoAmmo");
				}
				else
				{
					return resolvestate("Reload");
				}
			}
			if(player.cmd.buttons & BT_USER3)
			{
				if(!invoker.noSpecial)
				{
					return resolvestate("User3");
				}
			}
			else
			{
				invoker.noSpecial = false;
			}
			if(player.cmd.buttons & BT_USER2)
			{
				if(CountInv("AmmoFragGrenade") > 0 || CountInv("AmmoPipeBomb") > 0 || CountInv("PowerSpeed2") > 0)
				{
					A_Overlay(90,"TossGrenade");
					return resolvestate("Grenade");
				}
				else
				{
					A_Print("Out of grenades");
				}
			}
			//Flag for if holding throwable object
			If(findinventory("hasagib"))
			{
				return resolvestate("ChooseYourGib");
			}
			
			
			If(invoker.a_checksprint() && cansprint)
			{
				return resolvestate('Sprint');
			}
			//Slidekick
			if (BDPplr.player.crouchfactor != 1 && player.cmd.buttons & BT_USER1 && (BDPplr.player.cmd.buttons & BT_CROUCH || BDPplr.player.oldbuttons & BT_CROUCH) && kickflashes && bdpplr && !bdpplr.exhausted && BDPplr.haskicked == 1) {
				return resolvestate('SlideKick');
			}
			//Airkick
			Else if (Vel.Z != 0 && player.cmd.buttons & BT_USER1 && kickflashes && BDPplr.haskicked == 1) {
				return resolvestate('AirKick');
			}
			//Regular kick	
			else If (player.cmd.buttons & BT_USER1 && kickflashes && BDPplr.haskicked == 1){
				return resolvestate('Kick');
			}
			
			//Middle finger
			if(CountInv(invoker.GetClassName()) > 1 && invoker.initDual == 0) {return resolvestate("SpecialAction");}
			
			return resolvestate(null);
			
		
		}
	
	Action void A_instaraise()

	{
    let psp = Player.FindPSprite(OverlayID()); //get pointer to current sprite layer;
    if (psp)
      psp.y = WEAPONTOP; //set offset immediately to the fully raised position;
	}
	
    action bool JustPressed(int which) // "which" being any BT_* value, mentioned above or not
    {
        return player.cmd.buttons & which && !(player.oldbuttons & which);
    }
    action bool JustReleased(int which)
    {
        return !(player.cmd.buttons & which) && player.oldbuttons & which;
    }
	
	action void MoveSpeed(float pspeed, float psidemove)
	{
		Brutal_PlayerBase(self).Speed = pspeed;
		Brutal_PlayerBase(self).SideMove1 = psidemove;
		Brutal_PlayerBase(self).SideMove2 = psidemove;
	}
	
	//Credit Agent_Ash aka Jekyll Grim Payne and Boondorl
	//Changes ammo type
	action void SetAmmoType1(bool set, Class<Ammo> ammoclass)
	{
		if (set) 
		{
			invoker.ammotype1 = ammoclass;
			invoker.ammo1 = Ammo(FindInventory(ammoclass));
			return;
		}
		invoker.ammo1 = null;
	}
	action void SetAmmoType2(bool set, Class<Ammo> ammoclass)
	{
		if (set)
		{
			invoker.ammotype2 = ammoclass;
			invoker.ammo2 = Ammo(FindInventory(ammoclass));
			return;
		}
		invoker.ammo2 = null;
	}
	
	//Credit Mikk0451
	//Changes ammo icon only
	action void ChangeWeaponIcon(String Icon)
	{
		invoker.althudicon = texman.CheckForTexture(Icon, TexMan.Type_Any);
	}
	action void ChangeAmmoIcon1(String AmmoIcon)
	{
		(findInventory(invoker.ammo1.GetClassName())).icon = texman.CheckForTexture(AmmoIcon, TexMan.Type_Any);
	}
	action void ChangeAmmoIcon2(String AmmoIcon)
	{
		(findInventory(invoker.ammo2.GetClassName())).icon = texman.CheckForTexture(AmmoIcon, TexMan.Type_Any);
	}
	action void ChangeAmmoIcon3(String AmmoIcon)
	{
		(findInventory(invoker.AmmoType3)).icon = texman.CheckForTexture(AmmoIcon, TexMan.Type_Any);
	}
	
	action void LedgeReach(float HeightDecrease)
	{
		let plr = Brutal_PlayerBase(self);
		plr.LedgeHeightMax = (plr.LedgeHeight - Height * HeightDecrease * 1.0f);
		A_Stop();
		SetOrigin((Pos.X, Pos.Y, plr.LedgeHeightMax), True);
	}
	//by Emerald
	action void A_SetCVAR(string cvartoset, int valuetoset)
    {
        CVar.GetCVar(cvartoset, Player).SetInt(valuetoset);
    }
	

	
	Bool A_checksprint()
	{
		Brutal_Playerbase Player = Brutal_playerbase(owner);
		If(!Player || !Player.bsprinting)
		{
			Return False;
		}
		Else
		{
			Return True;
		}
	}
	
	action state A_KeepSprinting(int dxflags = 0, statelabel end = "SprintEnd")
	{
		If(invoker.A_checksprint())
		{
		Return A_WeaponReadyDX(dxflags,false,false);
		Return ResolveState(null);
		}
		Else
		{
		Return resolvestate(end);
		}
	}
	
	Action void A_AlertMonstersDX(double maxdist = 0, int flags = 0)
	{
		A_alertmonsters(maxdist,flags);
		
		if(invoker.owner.bshadow)
		{
			invoker.owner.giveinventory("moveblurspheretarget",1);
		}
	}
	
	action void a_semiflag()
	{
		invoker.refireq = false;
		invoker.semiclear = false;
		invoker.semiautofired = true;
	}
	
	action state A_SemiRefire(statelabel RefireLabel, statelabel FailLabel)
	{
		If(invoker.refireq)
		{
			invoker.refireq = false;
			invoker.semiautofired = false;
			invoker.semiclear = false;
			Return ResolveState(refirelabel);
		}
		Else if(invoker.owner.player.cmd.buttons & BT_ATTACK)
		{
			Return resolvestate(FailLabel);
		}
		Else
		{
			invoker.refireq = false;
			invoker.semiautofired = false;
			invoker.semiclear = false;
			Return resolvestate(null);
		}
	}
	
	override void DoEffect() 
	{
		super.DoEffect();
		
		let player = owner.player;
		brutal_playerbase BDPplr = brutal_playerbase(owner);
		//Flag that forces this weapon to be selected
		//Used for things that can't be switched off from
		//Like explosive barrels
		If(owner && forceselect)
		{
			owner.A_selectweapon(self.getclass());
		}
		If(player && player.readyweapon is self.getclass())
		{
			If(semiautofired && !(player.cmd.buttons & BT_ATTACK))
			{
				semiclear = true;
			}
			
			If(semiclear && player.cmd.buttons & BT_ATTACK)
			{
				refireq = true;
			}
			
			If(owner.findinventory("rollingstamina"))
			{
				If(owner.findinventory("istacticalclass"))
				{
					owner.A_GiveInventory("UsedStamina", weight * 30);
				}
				owner.takeinventory("rollingstamina",1);
	
			}
			If(!owner.findinventory("grabbermodifier"))
			{
				owner.giveinventory("grabbermodifier",1);
			}
			if(owner.findinventory("sprintbob")) 
			{
				if (player && player.readyweapon) 
				{
					player.WeaponState |= WF_WEAPONBOBBING;
				}
			}
			//player.readyweapon.A_setcvar("throwabletype",0);
			
			bool autogrenadeswitch;
			
			If(owner.countinv("nadetype") == 0 && owner.countinv("ammofraggrenade") == 0 && owner.countinv("ammopipebomb"))
			{
				autogrenadeswitch = true;
			}
			If(owner.countinv("nadetype") == 1 && owner.countinv("AmmoPipeBomb") == 0 && owner.countinv("ammofraggrenade") >= 1)
			{
				autogrenadeswitch = true;
			}
			
			If(owner.countinv("ammofraggrenade") > 0 && owner.countinv("ammopipebomb") < 1 || owner.countinv("ammofraggrenade") < 1 && owner.countinv("ammopipebomb") > 0)
			Owner.takeinventory("grenadeswapping",1);
			
			If(owner.findinventory("grenadeswapping") || autogrenadeswitch)
			{
			
	

				if(owner.CountInv("NadeType") == 0)
				{
					owner.giveinventory("nadetype",1);
					If(!autogrenadeswitch && owner.countinv("ammopipebomb") > 0)
					owner.A_startSound ("PIPESEL",92);
					//owner.A_Print("\cnFreeze grenades selected.",2);
				}
				Else
				{
					owner.takeinventory("nadetype",666);
					If(!autogrenadeswitch && owner.countinv("ammofraggrenade") > 0)
					owner.A_startSound ("GRNPIN",92);
					//owner.A_Print("Cluster grenades selected.",2);
				}
				
			}
			Owner.takeinventory("grenadeswapping",1);
		
			
			If(A_checksprint())
			{
				
				If(owner.findinventory("istacticalclass") && BDPplr)
				{
					If(owner.findinventory("powerstrength") || owner.findinventory("powerboost"))
					{
						if (level.time % 2 == 0)
						{
							BDPplr.stamina += 2;
						}
					}
					Else
					{
						if (level.time % 2 == 0)
						{
							BDPplr.stamina += 3;
						}
					}
					
				}
				
				BobRangeX = 1.0;
				BobRangeY = 1.0;
				BobSpeed = 3.9;
				//owner.speed = (owner.default.speed * 2);
	
				//owner.acs_namedexecute("fastplayer",0,0,0,0);
				//owner.takeinventory("sprintbob",1);
			}
			else
			{
				BobRangeX = 0.4;
				BobRangeY = 0.4;
				BobSpeed = 2.9;
				//owner.takeinventory("sprintbob",1);
				//owner.acs_namedexecute("slowplayer",0,0,0,0);
				
				//owner.speed = owner.default.speed;
			}
  
 
  
			if(GetCvar("smooth_mouse") == true ) 
			{
				if (player && player.readyweapon) {
				player.WeaponState |= SPF_INTERPOLATE;
				}
			}
  
  //Hacky fix for weapon timers
			If(owner.countinv("cyberdemonrockets") == 1 || owner.countinv("spiderchainguntimer") == 1)
			{
				guntimertics = (guntimertics + 1);
		
				If(guntimertics > 35)
				{
					owner.takeinventory("cyberdemonrockets",666);
					owner.takeinventory("spiderchainguntimer",666);
				}
			}
			Else
			{
				guntimertics = 0;
			}
	
			//No more death overlaysssss
			If(owner.health < 1)
			{
				owner.A_clearoverlays(-700,30,false);
			}
		
			If(gunslingertics < 175)
			{
				Gunslingertics = 175;
			}
			//Console.printf(self.getclassname());
		}
		Else
		{
			If(gunslingertics > 0)
			{
				Gunslingertics--;
			}
			If(gunslingertics == 0 && !gunslingereligible && gunslinger && mag <= magcapacity)
			{
				Gunslingereligible = true;
				owner.A_startsound("GUNSLNG",424,0,1);
			}
			If(gunslingertics == 0 && !gunslingereligible && gunslinger && gunslinger2)
			{
				Gunslingereligible = true;
				owner.A_startsound("GUNSLNG",424,0,1);
			}
		}
  
}
	
	Override void attachtoowner(Actor other)
		{
			Gunslingereligible = true;
			Super.attachtoowner(other);
		}
	
	
	States
	{
	//Fallback weapon states
	Grenade: //32
		TNT1 A 32;
		Goto Ready;
	Kick: //16
		TNT1 A 16;
		Goto Ready;
	AirKick: //18
		TNT1 A 18;
		Goto Ready;
	SlideKick: //26
		TNT1 A 26;
		Goto Ready;
	Taunt: //30
		TNT1 A 30;
		Goto Ready;
	Sprint:
		TNT1 A 4 A_WeaponReadyDX(WRF_ALLOWRELOAD,false,false);
	SprintLoop:
		TNT1 A 1 A_KeepSprinting(WRF_ALLOWRELOAD);
		Loop;
	SprintEnd:
		TNT1 A 4 A_WeaponReadyDX(WRF_ALLOWRELOAD,false,false);
		Goto Ready;
		
	
	
		Tripmineoverlay:
			TNT1 A 10;
			TRPM FEDCBBBB 1;
			TRPM B 1
				{
				
				FLineTraceData wallinmyway;
				invoker.owner.LineTrace(invoker.owner.angle, 64, invoker.owner.pitch, 0, offsetz: 12, data: wallinmyway);
				if (wallinmyway.HitType == TRACE_HitWall)
				{
					A_fireprojectile("TripMineProjectile",0,true,0,-4);
					A_TakeMag();
					return ResolveState("Placedsuccesfully");
				}
				Return resolvestate(null);
				}
			TRPM BBBMNOPQ 1;
			//TNT1 A 10;
			Stop;
			
			placedSuccesfully:
			TRPM GGGGGHIJKL 1;
			//TNT1 A 10;
			Stop;
			
			
			
			Select:
			Deselect:
			Fire:
			Ready:
			TNT1 A 1 A_Jump(255, "Ready");
			Loop;	
		Stop;
		instadeselect:
		TNT1 A 0 A_lower();
		Wait;
		Ready3:
			TNT1 A 1 A_Jump(255, "Ready3");
			Loop;	
			
		StainedLedgeClimb:
			3L1M A 0 A_JumpIfInventory("PowerGreenBloodOnVisor",1,4);
			2L1M A 0 A_JumpIfInventory("PowerBlueBloodOnVisor",1,3);
			1L1M A 0 A_JumpIfInventory("PowerBloodOnVisor",1,2);
		LedgeClimb:
			CL1M A 0;
			"####" A 0 
			{
			If(invoker.clearoverlays)
				{
				 A_clearoverlays(-30,30);
				}
			}
			"####" A 0 A_overlay(5,"donothing");
			
			"####" A 0 A_ClearOverlays(6,6);
			"####" A 0 A_takeinventory("sprintbob",1);
			"####" A 0 A_Stop();
			"####" A 0 A_ZoomFactor(1.0);
			"####" A 0 A_GunFlash("LedgeGrabFlash");
			"####" A 0 A_WeaponReady(WRF_NOFIRE|WRF_ALLOWRELOAD|WRF_NOSWITCH);
			"####" A 0 SetPlayerProperty(0,1,PROP_TOTALLYFROZEN);
			"####" A 0 
			{

			A_StartSound("ledgeclimb",5);
			}
			"####" ABC 1 {
				let plr = Brutal_PlayerBase(self);
				
				if(Pos.Z < (plr.LedgeHeight - Height * 0.78f))
				{
					A_SetPitch(pitch-pitch/2, SPF_INTERPOLATE);
					Vel = Vel.Length() ? (0, 0, plr.velz) : (0, 0, 0);
					//plr.velz--;
				}
				else if(Pos.Z < (plr.LedgeHeight - Height * 0.76f))
				{
					LedgeReach(0.751);

					return ResolveState("LedgeReach");
					
				}
				return ResolveState(null);
			}
		LedgeReach:
			"####" D 1 {
				let plr = Brutal_PlayerBase(self);
				//if(Pos.Z >= (plr.LedgeHeight - Height * 0.78f) && Pos.Z < (plr.LedgeHeight - Height * 0.76f))
				if(Pos.Z >= (plr.LedgeHeight - Height * 0.78f))
				{
					A_SetPitch(pitch-pitch/2, SPF_INTERPOLATE);
					GiveInventory("Grabbing_A_Ledge", 1);
					LedgeReach(0.751);
				}
				else if(Pos.Z < (plr.LedgeHeight - Height * 0.78f))
				{
					Vel = Vel.Length() ? (0, 0, plr.velz) : (0, 0, 0);
				}
			}
			"####" A 0 A_JumpIf(CountInv("Grabbing_A_Ledge")==1, 1);
			Goto LedgeReach;
			
			"####" E 1 {
				let plr = Brutal_PlayerBase(self);
				
				plr.velz = 3.6;
				A_SetPitch(0, SPF_INTERPOLATE);
				LedgeReach(0.751);
				A_StopSound(CHAN_WEAPON);
				plr.LedgeAngle = Angle;
				plr.LedgeCheck = False;
				plr.LedgeGrabbed = True;
			}
			"####" F 1 {
				A_SetPitch(pitch-0.5, SPF_INTERPOLATE);
				Vel = Vel.Length() ? (0, 0, 0.5) : (0, 0, 0);
			}
			"####" G 1 {
				let plr = Brutal_PlayerBase(self);
				A_SetPitch(pitch+3, SPF_INTERPOLATE);
				Vel = Vel.Length() ? (0, 0, plr.velz) : (0, 0, 0);
			}
			"####" HI 1 {
				let plr = Brutal_PlayerBase(self);
				A_SetPitch(pitch+4, SPF_INTERPOLATE);
				Vel = Vel.Length() ? (0, 0, plr.velz) : (0, 0, 0);
			}
		FinishClimb:
			3L1M A 0 A_JumpIfInventory("PowerGreenBloodOnVisor",1,4);
			2L1M A 0 A_JumpIfInventory("PowerBlueBloodOnVisor",1,3);
			1L1M A 0 A_JumpIfInventory("PowerBloodOnVisor",1,2);
			CL1M A 0;
			"####" A 0 A_GunFlash("LedgeGrabFlash");
			"####" JK 1 {
				let plr = Brutal_PlayerBase(self);
				
				plr.velz = 3.6;
				A_SetPitch(pitch-3, SPF_INTERPOLATE);
				Vel = Vel.Length() ? (0, 0, plr.velz) : (0, 0, 0);
			}
			"####" LM 1 A_SetPitch(pitch-2, SPF_INTERPOLATE);
			TNT1 AA 1 {
				A_SetPitch(pitch-pitch/2, SPF_INTERPOLATE);
				A_WeaponReady(WRF_NOSWITCH);
			}
			TNT1 A 0 A_SetPitch(0, SPF_INTERPOLATE);
			TNT1 A 0 SetPlayerProperty(0,0,PROP_TOTALLYFROZEN);
			TNT1 A 0 TakeInventory("Grabbing_A_Ledge", 1);
			TNT1 A 0 A_JumpIf(GetCvar("bd_Legs")==1, 2);
			//TNT1 A 0 A_Overlay(-610, "FirstPersonLegsStand");
			TNT1 A 0;
			TNT1 A 0 A_jumpifinventory("hasagib",1,"Chooseyourgib");
			//Goto Ready3;
			TNT1 A 0
			{
			If(invoker is "hellishmissilelauncher")
				{
				 return resolvestate("ready");
				}
				Else
				{
				Return resolvestate(null);
				}
			}
			TNT1 A 0 A_Jump(256,"ReturnFromNothing");
			Goto Ready;
			//Goto SelectAnimation;
			
			
			
			
			InAVehicle:
			TNT1 A 3;
			Goto returnFromNothing;
			
			Donothing:
	TNT1 A 0;
	Stop;
	Idle:
	TNT1 A 0 setplayerproperty(0,1,4);
	TNT1 A 2;
	TNT1 A 0 setplayerproperty(0,0,4);
	TNT1 A 0 A_jumpifinventory("hasagib",1,"Chooseyourgib");
	
	TTN1 A 0 A_jump(256,"returnfromnothing");
	returnFromNothing:
	
	GoingToReady:
	SelectingAnimation:
		  TNT1 A 0 A_JumpIf(GetCvar("bd_Legs")==1, 2);
		//  TNT1 A 0 A_Overlay(-610, "FirstPersonLegsStand");
		  TNT1 A 0;
		  SprintEnd:
		  TNT1 A 0 A_jumpifinventory("needstoselect",1,"InitWeaponState");
		  TNT1 A 0 A_TakeInventory("BDWEaponACtion", 1);
		  TNT1 A 0 A_TakeInventory("ExecuteDownedEnemy", 1);
		  TNT1 A 0 A_TakeInventory("Kicking",1);
		  TNT1 A 0 A_TakeInventory("Salute1", 1);
		  TNT1 A 0 A_TakeInventory("Salute2", 1);
		  TNT1 A 0 A_TakeInventory("Taunting",1);
		  TNT1 A 0 A_TakeInventory("TossGrenade",1);
		  TNT1 A 0 A_TakeInventory("IsRunning",1);
		  TNT1 A 0 A_TakeInventory("Reloading",1);
		  TNT1 A 0 A_jumpifinventory("hasagib",1,"Chooseyourgib");
		  TNT1 A 0 A_Overlay(10, "Flash");
		  TNT1 A 0 A_Jump(256, "Ready");
		//   TNT1 A 0 A_Jump(256, "Ready");
		  Loop;
	
	InitWeaponState:		
		TNT1 A 0;
		//TNT1 A 1 Emma you fucking idiot
		TNT1 A 0
		{
		
		takeinventory("startdualwield",1);
		takeinventory("swapriflespecial",1);
		takeinventory("reloading",1);
		takeinventory("unloading",1);
		takeinventory("taunting",1);
		takeinventory("tossgrenade",1);
		takeinventory("salute1",1);
		takeinventory("salute2",1);
		takeinventory("kicking",1);
		takeinventory("zoomed",1);
		takeinventory("sprintbob",1);
		A_zoomfactor(1.0);
		If(!(invoker is "Explosivebarrelweapon"))
		{
			Invoker.owner.takeinventory("explosivebarrelweapon",1);
		}
		invoker.aimMode = 0;
		invoker.scopeZoom = false;
		invoker.refireq = false;
		invoker.semiautofired = false;
		invoker.semiclear = false;
		
		A_SetCrosshair(-1);
		a_weaponvoiceline();
		A_WeaponReady(WRF_NOFIRE);
		if(invoker.dualWeapon && countinv(invoker.GetClassName()) > 1 && invoker.dualWield == 1 && GetCVar("bd_smartdualwield") == 0)
		{
			A_SelectWeapon(invoker.dualWeapon);
			return resolvestate("InstaDeselect");
		}
		if(invoker.dualWeapon && invoker.switchingDual == true)
		{
			invoker.switchingDual = false;
			return resolvestate("SelectFromDual");
		}
		return resolvestate(null);
		}
		TNT1 A 0 A_jumpifinventory("hasagib",1,"gibfromnothing");
		TNT1 A 0 A_Jump(256, "Select");
		Loop;
	User4:
		"####" "#" 0 A_Overlay(69,"TauntAction");
		"####" "#" 0 A_Jump(256,"Taunt");
		Goto Ready;
   TauntAction:
		TNT1 A 0 A_Takeinventory("Zoomed",1);
        TNT1 A 0 A_ZoomFactor(1.0);
		TNT1 A 0 A_Takeinventory("Taunting",1);
		"####" A 0 A_jumpif(invoker.handedness == 2, "tauntnone");
        TNT1 A 4;
		6UCK A 0 A_JumpIfInventory("PowerGreenBloodOnVisor",1,4);
		5UCK A 0 A_JumpIfInventory("PowerBlueBloodOnVisor",1,3);
		4UCK A 0 A_JumpIfInventory("PowerBloodOnVisor",1,2);
		FUCK N 0;
		"####" A 0;
		"####" A 0;
		
		"####" A 0 BRIGHT A_FireProjectile("Taunter", 0, 0, -1, 0);
		"####" A 0 BRIGHT A_FireProjectile("Taunter", -9, 0, -1, 0);
		"####" A 0 BRIGHT A_FireProjectile("Taunter", 9, 0, -1, 0);
		//"####" A 0 A_JumpIfInventory("GenderFemale", 1, "TauntFemale");
		"####" A 0 
		{
			If(random(1,200) == 7)
			{
				A_startsound("FUCK5",455);
			}
			Else
			{
				A_startsound("FUCK",455);
			}
		}
	FinishTaunt:
		"####" A 0 A_jumpif(invoker.handedness == 1, "Finishtauntleft");
		
		
        "####" ABCD 1 A_AlertMonsters();
		"####" E 1;
		"####" F 12;
        "####" EDCBA 1;
        TNT1 A 4 A_Takeinventory("Taunting",1);
		TNT1 A 0 A_jumpifinventory("hasagib",1,"Chooseyourgib");
		Stop;
	FinishTauntLeft:
	//"####" A 0 A_GunFlash("Taunt");
        "####" GHIJ 1 A_AlertMonsters();
		"####" K 1;
		"####" L 12;
        "####" KJIHG 1;
        TNT1 A 4 A_Takeinventory("Taunting",1);
		TNT1 A 0 A_jumpifinventory("hasagib",1,"Chooseyourgib");
		Stop;
		
	TauntNone:
	6UCK A 0 A_JumpIfInventory("PowerGreenBloodOnVisor",1,4);
		5UCK A 0 A_JumpIfInventory("PowerBlueBloodOnVisor",1,3);
		4UCK A 0 A_JumpIfInventory("PowerBloodOnVisor",1,2);
		FUCK N 0;
		"####" A 0;
		"####" A 0;
		"####" A 0 BRIGHT A_FireProjectile("Taunter", 0, 0, -1, 0);
		"####" A 0 BRIGHT A_FireProjectile("Taunter", -9, 0, -1, 0);
		"####" A 0 BRIGHT A_FireProjectile("Taunter", 9, 0, -1, 0);
		//"####" A 0 A_JumpIfInventory("GenderFemale", 1, "TauntFemale");
		"####" A 0 A_Jump(256, "FuckYourself2", "FhaccYoself2", "GoFuckYourself2", "GetOffScum2");
		
		FuckYourself2:
		"####" A 0 ACS_NamedExecute("InsultFuckYourself",0,0);
        "####" B 0 A_StartSound("FUCK1", 2);
		Goto FinishTauntnone;
	FhaccYoself2:
		"####" A 0 ACS_NamedExecute("InsultFhaccYoself",0,0);
        "####" B 0 A_StartSound("FUCK3", 2);
		Goto FinishTauntnone;
	GoFuckYourself2:
		"####" A 0 ACS_NamedExecute("InsultGoFuckYourself",0,0);
        "####" B 0 A_StartSound("FUCK4", 2);
		Goto FinishTauntnone;
	GetOffScum2:
		"####" A 0 ACS_NamedExecute("InsultGetOffScum",0,0);
        "####" B 0 A_StartSound("FUCK2", 2);
	FinishTauntNone:
		TNT1 A 0 A_Takeinventory("Taunting",1);
		TNT1 A 0 A_jumpifinventory("hasagib",1,"Chooseyourgib");
		Stop;
	TossPipebomb:
		TNT1 A 5;
		//TNT1 A 0 A_JumpIf(player.cmd.buttons & BT_USER2, "DetonateTossedPipebomb");
		//NULL A 0 A_JumpIfInventory("HasThrownPipebomb",1,"DetonateTossedPipebomb");
		RAIL A 0 A_Takeinventory("HasFreezerWeapon",1);
		"----" A 0 A_Takeinventory("HasPlasmaWeapon",1);
		TNT1 A 0 A_TAkeinventory("HasCutingWeapon",1);
		TNT1 A 0 A_Takeinventory("Zoomed",1);
		TNT1 A 0 A_Takeinventory("PowerLightAmp",1);
        TNT1 A 0 A_ZoomFactor(1.0);
		TNT1 A 0 A_Takeinventory("ADSmode",1);
		TNT1 A 0 A_JumpIfInventory("IsPlayingAsPurist", 1, "TossGrenadeClassic");
	    TNT1 A 2; //20 frames left
		//NULL A 0 A_JumpIfInventory("HasThrownPipebomb",1,"DetonateTossedPipebomb")
		TNT1 A 0 A_startsound("MineArm",2);
		DKPB PQRSTU 1;
		DKPB FGHI 1;
		TNT1 A 0 A_StartSound("DukeThrw");
		//NULL A 0 A_GiveInventory("HasThrownPipebomb",1);
        TNT1 A 0 
		{
		if(CountInv("TossGrenade")==1)
			{
			A_FireProjectile("PipebombThrownSlow",0,0,0,0);
			A_QuadSound();
			}
		else
			{
			A_FireProjectile("PipebombThrownQuickTossed",0,0,0,0);
			A_QuadSound();
			}
		}
		BFGN A 0 A_TakeAmmo("AmmoPipeBomb", 1);
		DKPB JKKKLLM 1;
		DKPB NO 1;
		TNT1 A 6;
		NULL A 0 A_TakeInventory("TossGrenade",1);
		Stop;
	User3:
		"####" "#" 0 {invoker.noSpecial = true;}
		"####" "#" 0 A_Jump(256,"SpecialAction");
		Goto Ready;
	TossGrenade:
		"----" "#" 0 A_TakeInventory("TossGrenade", 1);
		NULL A 0 A_JumpIf(CountInv("NadeType")==1,"TossPipebomb");
		"----" "#" 0;
		TNT1 A 5;
		//TNT1 A 0 A_JumpIf(player.cmd.buttons & BT_USER2, "DetonateTossedPipebomb");
		//NULL A 0 A_JumpIfInventory("HasThrownPipebomb",1,"DetonateTossedPipebomb");
		RAIL A 0 A_Takeinventory("HasFreezerWeapon",1);
		"----" A 0 A_Takeinventory("HasPlasmaWeapon",1);
		TNT1 A 0 A_TAkeinventory("HasCutingWeapon",1);
		TNT1 A 0 A_Takeinventory("Zoomed",1);
		TNT1 A 0 A_Takeinventory("PowerLightAmp",1);
        TNT1 A 0 A_ZoomFactor(1.0);
		TNT1 A 0 A_Takeinventory("ADSmode",1);
		TNT1 A 0 A_JumpIfInventory("IsPlayingAsPurist", 1, "TossGrenadeClassic");
		
		GRTH A 1;
		GRTH BCDE 1;
		GRTH F 1;//3
		GRTH G 1;//H 1
		GRTH I 1;//3
		TNT1 A 0 A_GiveInventory("FiredGrenade", 1);
		TNT1 A 0 A_Giveinventory("Punching",1);
		TNT1 A 0 A_Giveinventory("GoSpecial",1);
		TNT1 A 0 A_StartSound ("GRNPIN");
		GRTH JKLMN 1;
		TNT1 A 2;
		TNT1 A 0 A_StartSound ("CS16uwu");
		TNT1 A 0 A_Jump(2,2);
		TNT1 A 0 A_StartSound ("GRNTOSS");
		TNT1 A 0;
		//TNT1 A 0 A_JumpIfInventory("TossGrenade", 1, "TossGrenadeGently");
		//TNT1 A 0 A_Recoil(-2)
		GRTH OP 1;
		TNT1 A 0 A_TakeAmmo("AmmoFragGrenade", 1);
		TNT1 A 0 A_FireProjectile("FakeGrenade", 0, 0, 0, 0, 0, 0);
	    TNT1 A 0 A_TakeInventory("FiredGrenade", 1);
		TNT1 A 0 A_FireProjectile("HandGrenade", 0, 0, 0, 0, 0, 0);
		"####" A 0 A_QuadSound();
		GRTH Q 1;
		GRTH RSTU 1;
		TNT1 A 5; //32 frames in total for a flash.
		TNT1 A 0 A_TakeInventory("TossGrenade", 1);
		TNT1 A 0 A_GunFlash();
		Stop;	
	BloodSplashRed:
		TNT1 A 1
		{
		a_overlaypivotalign(overlayid(),PSPA_CENTER,PSPA_CENTER);
		a_overlayflags(OverlayID(),PSPF_ADDWEAPON | PSPF_ADDBOB,false);
		a_overlayoffset(OverlayID(),random(-150,150),random(0,0));
					
						If(random(1,2)== 1)
							{
							a_overlayflags(OverlayID(),PSPF_FLIP,false);
							}
						Else
							{
							a_overlayflags(OverlayID(),PSPF_FLIP,true);
							}
			int randomrot = (random(0,3));
			If(randomrot == 3)
			{
				a_overlayrotate(Overlayid(),90);
			}
			Else If(randomrot == 2)
			{
				a_overlayrotate(Overlayid(),180);
			}
			Else If(randomrot == 1)
			{
				a_overlayrotate(Overlayid(),270);
			}
			
			A_overlayscale(overlayid(),frandom(0.3,1.5));
		
		}
		SBDR A random(10,30);
		SBDR AAAAAAAAAAAAAAAAAAAAA 1 A_overlayfadeout(0.05); 
		Stop;
	BloodSplashGreen:
	TNT1 A 1
		{
		a_overlaypivotalign(overlayid(),PSPA_CENTER,PSPA_CENTER);
		a_overlayflags(OverlayID(),PSPF_ADDWEAPON | PSPF_ADDBOB,false);
		a_overlayoffset(OverlayID(),random(-150,150),random(0,0));
					
						If(random(1,2)== 1)
							{
							a_overlayflags(OverlayID(),PSPF_FLIP,false);
							}
						Else
							{
							a_overlayflags(OverlayID(),PSPF_FLIP,true);
							}
			int randomrot = (random(0,3));
			If(randomrot == 3)
			{
				a_overlayrotate(Overlayid(),90);
			}
			Else If(randomrot == 2)
			{
				a_overlayrotate(Overlayid(),180);
			}
			Else If(randomrot == 1)
			{
				a_overlayrotate(Overlayid(),270);
			}
			
			A_overlayscale(overlayid(),frandom(0.3,1.5));
		
		}
		SBDG A random(10,30);
		SBDG AAAAAAAAAAAAAAAAAAAAA 1 A_overlayfadeout(0.05); 
		Stop;
		
	BloodSplashBlue:
		TNT1 A 1
		{
		a_overlaypivotalign(overlayid(),PSPA_CENTER,PSPA_CENTER);
		a_overlayflags(OverlayID(),PSPF_ADDWEAPON | PSPF_ADDBOB,false);
		a_overlayoffset(OverlayID(),random(-150,150),random(0,0));
					
						If(random(1,2)== 1)
							{
							a_overlayflags(OverlayID(),PSPF_FLIP,false);
							}
						Else
							{
							a_overlayflags(OverlayID(),PSPF_FLIP,true);
							}
			int randomrot = (random(0,3));
			If(randomrot == 3)
			{
				a_overlayrotate(Overlayid(),90);
			}
			Else If(randomrot == 2)
			{
				a_overlayrotate(Overlayid(),180);
			}
			Else If(randomrot == 1)
			{
				a_overlayrotate(Overlayid(),270);
			}
			
			A_overlayscale(overlayid(),frandom(0.3,1.5));
		
		}
		SBDB A random(10,30);
		SBDB AAAAAAAAAAAAAAAAAAAAA 1 A_overlayfadeout(0.05); 
		Stop;
		ReadyShotgunguyHEad:
        //TNT1 A 0 A_JumpIfInventory("Kicking",1,"KickAction")
        PTG1 B 1 A_jumpif(invoker.owner.player.cmd.buttons & bt_attack, "shotgunguyheadfire");
		LOOP;
	}
}


CLASS TemporaryWeapon : BrutalWeapon
{
	bool hasexploded;
	Override void doeffect()
	{
		if (level.time % 35 == 0 && owner.player.readyweapon is self.getclass()) {
			if (owner.countinv(ammotype1) > 0)
			{
				
					owner.Takeinventory(ammotype1,1);
					
			}
			
		}
		Super.doeffect();
	}
	
	States
	{
		GunExplodes:
		TNT1 A 0 A_overlay(5,"GunExplodeOverlay");
	    TNT1 A 6;
		NULL A 0 A_FireProjectile("TempGunExplosionSpawner", 0, 0, 0, 0, -2);
		NULL A 0 A_WeaponOffset(0,32);
		
		//CYBF X 70
		2YBF ABCDD 1;
		2YBF E 12;
		2YBF EFGHIJJ 1;
		2YBF K 8;
		2YBF LMNOPQ 1;
		TNT1 A 2;
	//	NULL A 0 A_SelectWeapon("Melee_Attacks")
		TNT1 A 0 {invoker.depleteordestroy();}
	
	}
}



CLASS BloodSplasher : Actor
{
	Default
	{
	
    damagefactor "Trample", 0.0;
	DamageType "Blood";
	Health 1;
	Radius 1;
	Height 1;
    Mass 1;
	+NOCLIP;
	+NOGRAVITY;
	+ACTIVATEMCROSS;
    +WINDTHRUST;
    +NODAMAGETHRUST;
    +PIERCEARMOR;
	+BLOODLESSIMPACT;
	DeathSound "None";
	}
	States
	{
	Spawn:
		TNT1 A 0 A_ClearTarget();
		TNT1 A 0 A_Look();
		TNT1 A 0 A_RadiusGive("BloodSplasherZ", 96, RGF_PLAYERS, 1);
		TNT1 A 0 A_JumpIfInTargetInventory("BloodSplasherz", 1, "Blood");
		 Stop;

	Blood:
		TNT1 A 0 A_TakeFromTarget("BloodSplasherz", 1);
		TNT1 A 0 {A_GiveToTarget("BloodOnVisor",1);A_TakeFromTarget("PowerBlueBloodOnVisor",1);A_TakeFromTarget("PowerGreenBloodOnVisor",1);}
		//TNT1 A 0 A_GiveToTarget("BloodOnVisor", 1)
		TNT1 A 0 A_GiveToTarget("MeatAmmo", 1);
		TNT1 A 0 A_JumpIf(GetCvar("bd_ScreenFX")>=1, "BloodSplashStop");
	TNT1 A 0
	{
		If(target && target.player)
			{
			bool layerfound;
			int i = 110;
			
			until (layerfound)
				{
				
				If(!target.player.findpsprite(i))
					{
					
					target.player.SetPSprite(i,target.player.ReadyWeapon.FindState("bloodsplashred"));
					//target.a_overlayoffset(i,random(-180,180),random(-90,120));
					layerfound = true;
					
					}
				i++;
				}
			
			}
	}
		 
	BloodSplashStop:
		TNT1 A 1;
		//TNT1 A 0 A_Explode(3,250)
		//TNT1 A 0 A_Explode(3,120)
		Stop;
		
	}
}

CLASS TinyBloodSplasher : BloodSplasher
{

	States
	{
	Spawn:
		TNT1 A 0 A_ClearTarget();
		TNT1 A 0 A_Look();
		TNT1 A 0 A_JumpIf(GetCvar("bd_BloodTrail")==1, "BloodSplashStop");
		TNT1 A 0 A_RadiusGive("BloodSplasherZ", 48, RGF_PLAYERS, 1);
		TNT1 A 0 A_JumpIfInTargetInventory("BloodSplasherz", 1, "Blood");
		TNT1 A 1;
		 Stop;
		
	}
}

CLASS SuperBloodSplasher : BloodSplasher
{

	States
	{
	Spawn:
		TNT1 A 0 A_ClearTarget();
		TNT1 A 0 A_Look();
		TNT1 A 0 A_RadiusGive("BloodSplasherZ", 96, RGF_PLAYERS, 1);
		TNT1 A 0 A_JumpIfInTargetInventory("BloodSplasherz", 1, "Blood");
		Stop;
	}
}





// Blue Blood
CLASS BlueBloodSplasher : Bloodsplasher
{

	States
	{
	Spawn:
		TNT1 A 0 A_ClearTarget();
		TNT1 A 0 A_Look();
		TNT1 A 0 A_RadiusGive("BloodSplasherBlueBlood", 96, RGF_PLAYERS, 1);
		TNT1 A 0 A_JumpIfInTargetInventory("BloodSplasherBlueBlood", 1, "BlueBlood");
		Stop;

	BlueBlood:
		TNT1 A 0 A_TakeFromTarget("BloodSplasherBlueBlood", 1);
		TNT1 A 0 {A_TakeFromTarget("PowerBloodOnVisor",1);A_GiveToTarget("BlueBloodOnVisor",1);A_TakeFromTarget("PowerGreenBloodOnVisor",1);}
		//TNT1 A 0 A_GiveToTarget("BlueBloodOnVisor", 1)
		TNT1 A 0 A_JumpIf(GetCvar("bd_ScreenFX")>=1, "BlueBloodSplashStop");
	TNT1 A 0
	{
		If(target && target.player)
			{
			bool layerfound;
			int i = 110;
			
			until (layerfound)
				{
				
				If(!target.player.findpsprite(i))
					{
					
					target.player.SetPSprite(i,target.player.ReadyWeapon.FindState("bloodsplashblue"));
					//target.a_overlayoffset(i,random(-180,180),random(-90,120));
					layerfound = true;
					
					}
				i++;
				}
			
			}
	}
		
		 
	BlueBloodSplashStop:
		TNT1 A 1;
		//TNT1 A 0 A_Explode(3,250)
		//TNT1 A 0 A_Explode(3,120)
		Stop;
		
	}
}

CLASS BlueSuperBloodSplasher : BlueBloodSplasher
{

	States
	{
	Spawn:
		TNT1 A 0 A_ClearTarget();
		TNT1 A 0 A_Look();
		TNT1 A 0 A_RadiusGive("BloodSplasherBlueBlood", 96, RGF_PLAYERS, 1);
		TNT1 A 0 A_JumpIfInTargetInventory("BloodSplasherBlueBlood", 1, "BlueBlood");
		Stop;
	}
}




// Green Blood
CLASS GreenBloodSplasher : bloodsplasher
{

	States
	{
	Spawn:
		TNT1 A 0 A_ClearTarget();
		TNT1 A 0 A_Look();
		TNT1 A 0 A_RadiusGive("BloodSplasherGreenBlood", 96, RGF_PLAYERS, 1);
		TNT1 A 0 A_JumpIfInTargetInventory("BloodSplasherGreenBlood", 1, "GreenBlood");
		Stop;

	GreenBlood:
		TNT1 A 0 A_TakeFromTarget("BloodSplasherGreenBlood", 1);
		TNT1 A 0 {A_TakeFromTarget("PowerBloodOnVisor",1);A_TakeFromTarget("PowerBlueBloodOnVisor",1);A_GiveToTarget("GreenBloodOnVisor",1);}
	//	TNT1 A 0 A_GiveToTarget("GreenBloodOnVisor", 1)
		TNT1 A 0 A_JumpIf(GetCvar("bd_ScreenFX")>=1, "GreenBloodSplashStop");
	TNT1 A 0
	{
		If(target && target.player)
			{
			bool layerfound;
			int i = 110;
			
			until (layerfound)
				{
				
				If(!target.player.findpsprite(i))
					{
					
					target.player.SetPSprite(i,target.player.ReadyWeapon.FindState("bloodsplashgreen"));
					//target.a_overlayoffset(i,random(-180,180),random(-90,120));
					layerfound = true;
					
					}
				i++;
				}
			
			}
	}
		
		 
	GreenBloodSplashStop:
		TNT1 A 1;
		//TNT1 A 0 A_Explode(3,250)
		//TNT1 A 0 A_Explode(3,120)
		Stop;
	}
}

CLASS GreenSuperBloodSplasher : GreenBloodSplasher
{

	States
	{
	Spawn:
		TNT1 A 0 A_ClearTarget();
		TNT1 A 0 A_Look();
		TNT1 A 0 A_RadiusGive("BloodSplasherGreenBlood", 96, RGF_PLAYERS, 1);
		TNT1 A 0 A_JumpIfInTargetInventory("BloodSplasherGreenBlood", 1, "GreenBlood");
		Stop;
	}
}

class BDP_GunLight : DynamicLight 
{

	int alivetime; 
	property alivetime : alivetime;
	default {
		DynamicLight.Type "Point";
		+DYNAMICLIGHT.ATTENUATE;
		+DYNAMICLIGHT.SPOT
		self.alivetime 2;
	}
	override void Tick() {
		super.Tick();
		alivetime--;
		If(alivetime <= 0)
		{
			Destroy();
		}
	}

	
}
