CLASS BattleRifleAmmo : Ammo
{
	Default
	{
   Inventory.Amount 0;
   Inventory.MaxAmount 15;
   Ammo.BackpackAmount 0;
   Ammo.BackpackMaxAmount 15;
   Inventory.Icon "BR45A0";
   }
}

CLASS BattleRifle : Brutalweapon
{
	Default
	
	{
	Weapon.AmmoUse1 0;
	Weapon.AmmoUse2 0;
	Weapon.AmmoGive1 50;
	Weapon.AmmoGive2 0;
	Weapon.AmmoType1 "Clip2";
	Weapon.AmmoType2 "BattleRifleAmmo";
	Obituary "%o was pierced by %k's Battle Rifle.";
    Inventory.PickupSound "BR45PICK";
	Inventory.Pickupmessage "You got the Battle Rifle! (Slot 4)";
	+WEAPON.NOAUTOAIM;
	+WEAPON.NOAUTOFIRE;
	+WEAPON.NOALERT;
	+WEAPON.EXPLOSIVE;
	+FORCEXYBILLBOARD;
	scale 0.8;
	damagetype "Revolver";
	Weapon.SlotNumber 4;
	Weapon.SlotPriority 2;
	Weapon.SelectionOrder 1550;
	Inventory.AltHUDIcon "BR45A0";
	BrutalWeapon.weight 2;
	Tag "$BDPBR";


	}
	bool burstselected;
	int burstcount;
	int savedzoom;
	
	Action void a_FireBattleRifle()
	{
	
		FLineTraceData ricochetdata;
		invoker.owner.LineTrace(invoker.owner.angle, 4096, invoker.owner.pitch, TRF_SOLIDACTORS, offsetz: invoker.owner.player.viewz - invoker.owner.pos.z, data: ricochetdata);
		vector3 hitNormal;
		if(ricochetdata.HitType == TRACE_HitWall )
		{
			if(!ricochetdata.LineSide)
			{
				hitnormal = (ricochetdata.Hitline.delta.y, -ricochetdata.Hitline.delta.x, 0).unit();
			}
			else
			{
				hitnormal = (-ricochetdata.Hitline.delta.y, ricochetdata.Hitline.delta.x, 0).unit();
			}
			
		}
		else if (ricochetdata.HitType == TRACE_HitFloor)
		{
			hitnormal = ricochetdata.HitSector.FloorPlane.normal;
			
		}
		else if (ricochetdata.HitType == TRACE_HitCeiling)
		{
			hitnormal = ricochetdata.HitSector.CeilingPlane.normal;
		}
		Vector3 PlayerAngle = BDPMATH.AngletoVector3(1.0,invoker.owner.angle,invoker.owner.pitch);
		
		Vector3 BounceAngle = BDPMATH.BounceNormal(PlayerAngle,hitNormal);
		
		Double NextShotAngle;
		Double NextShotPitch;
		
		
		
		[NextShotAngle, NextShotPitch] = BDPMATH.Vector3toangles(BounceAngle);

		double anglediff = BDPMath.AngleDiff(invoker.owner.angle % 360.0,nextshotangle % 360.0);
		double pitchdiff = BDPMath.AngleDiff(invoker.owner.pitch % 360.0,nextshotpitch % 360.0);
		//Console.printf("%f",anglediff);
		
		
		Vector3 NextShotPosition = level.Vec3Offset(ricochetData.hitlocation, hitnormal * 2.0);
		
		A_FireBullets (0, 0, -1, 25, "BR45BulletPuff", FBF_NORANDOM,8192,"decorativetracer",-12);
		If(pitchdiff > 45 || anglediff > 45 || pitchdiff < -45 || anglediff < -45)
		{
			return;
		}
		If(ricochetdata.HitType == TRACE_HitWall || ricochetdata.HitType == TRACE_HitFloor || ricochetdata.HitType == TRACE_HitCeiling)
		{
			Invoker.Owner.LineAttack(NextShotAngle,8192,NextShotPitch,35,"Pistol","BR45BulletPuff",LAF_ABSPOSITION | LAF_ABSOFFSET,null,NextShotPosition.Z,NextShotPosition.x,NextShotPosition.y);
			let ricochettracer = Invoker.owner.spawn("decorativetracer",nextshotposition);
			If(ricochettracer)
			{
				ricochettracer.angle = nextshotangle;
				ricochettracer.pitch = nextshotpitch;
				ricochettracer.vel3dfromangle(140,nextshotangle,nextshotpitch);
			}
			
		}
	}
	
	States
	{
	
		GrenadeThrowFlash:
			BR4S ABCDE 1;
			TNT1 A 22;
			BR4S EDCBA 1;//32 in total
			stop;
			
		FuckYouFlash:
			BR4K ABCDEEEEEEEEEEEEEEEEEEEEEEDCBA 1; //18
			stop;
			
		KickingFlash:
			BR4K ABCDEEEEEEEEEEDCBA 1;
			Goto Ready;
		AirKickingFlash:
			BR4K ABCDEEEEEEEEEEDCBA 1; //18
			Goto Ready;
	
		SlideKickingStart:
			BR4K ABCDE 1;
			BR4K EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE 1 { //39 total
				if (CountInv("Kicking") == 0) {
					return resolvestate("SlideKickingEnd");
				}
				return resolvestate(null);
			}
			Goto Ready;

		SlideKickingEnd:
			BR4K EEEEEEDCBA 1; //10
			Goto Ready;
			
		SprintOverlay:
			BR4K ABCD 1 A_WeaponReadyDX(WRF_ALLOWRELOAD,FALSE,FALSE);
			KeepSprinting:
			BR4K E 1 A_weaponreadyDX(WRF_ALLOWRELOAD,FALSE,FALSE);
			"####" A 0 A_keepsprinting();
			Goto ReturnFromSprint;
			

	
		ReturnfromSprint:
			BR4K DCBA 1 A_weaponreadyDX(WRF_ALLOWRELOAD,FALSE,FALSE);
			Goto ready;
	
		Select:
			TNT1 A 0;
			//NULL A 0{if(GetCVAR("bd_SmartCrosshairs") == 1){A_SetCrosshair(GetCVAR("RailgunCrosshair"));}else{A_SetCrosshair(0);}}
			Goto SelectFirstPersonLegs;
		SelectContinue: "####" A 0 A_GiveInventory("IsPlayingDoxMod",1); 
			UNHG A 0 A_takeinventory("disabletilting",1);
			TNT1 AAAAAAAAAAAAAA 0 A_Raise();
			TNT1 A 1 A_Raise();
			//TNT1 A 0 A_Giveinventory("RailgunSelected",1);
			RIFL C 0 A_GunSlingerReload("battlerifleammo",15,"clip2",1);
			RIFL C 0 A_SetCrosshairDX("BR45Ret",2000,0.2);
		ReturnFromNothing:
			TNT1 A 0 A_startSound("BR45PICK",1);
			TNT1 AAA 0;
		
			Goto SelectAnimation;
		
		SelectAnimation:
			//NULL A 0{if(GetCVAR("bd_SmartCrosshairs") == 1){A_SetCrosshair(GetCVAR("RailgunCrosshair"));}else{A_SetCrosshair(0);}}
			BR4S EDCBA 1 A_WeaponReady(WRF_NOFIRE);
			GOto Ready;
			Deselect: 
				"####" A 0 A_TakeInventory("IsPlayingDoxMod",1);
				"####" A 0 A_ClearOverlays(-2,-2);
				BR4S ABCDE 1;
				TNT1 A 0 A_StopSOund(1);
				TNT1 A 0 A_StopSOund(2);
				TNT1 A 0 A_StopSOund(6);
				TNT1 A 0 A_TakeInventory("TossGrenade", 1);
				TNT1 AAAAAAAAAAAAAAAA 0 A_lower();
				TNT1 A 1 A_Lower();
				Wait;
		Ready:
			TNT1 A 0 
			{
				invoker.burstcount = 0;
			}
			
			BR45 B 1 A_weaponreadyDX(WRF_ALLOWRELOAD);
			TNT1 A 0 A_jumpif(countinv("battlerifleammo") < 1 && countinv("clip2") > 0,"reload");
			RIFL C 0 A_SetCrosshairDX("BR45Ret",2000,0.2);
			LOOP;

		Fidget:
			TNT1 A 0 A_overlay(-5,"pumpinghandlol");
			RAIL FGHI 1;
			
			RAIL JKLMNYYOO 1 A_WeaponReadyDX();
			TNT1 A 0 A_overlay(-5,"pumpinghandlol2");
			RAIL OOOO 1 A_WeaponReadyDX();
			TNT1 A 0 A_StartSound("RAILMAG2", 5);
			RAIL PR 1 A_WeaponReadyDX();
			RAIL TWWVUUUUUUUUU/*UUUUUUUUUU*/ 1 A_WeaponReadyDX();
			TNT1 A 0 A_StartSound("RAILINSR", 5);
			RAIL UUUUUTTSRQP 1 A_WeaponReadyDX();
			TNT1 A 0 A_overlay(-5,"pumpinghandlol2reverse");
			RAIL OOOOONMLKJ 1 A_WeaponReadyDX();
			TNT1 A 0 A_overlay(-5,"pumpinghandlolreverse");
			RAIL IHGF 1 A_WeaponReadyDX();
			Goto ready;

		Fire:
			TNT1 A 0 A_CheckIfAmmo("battlerifleammo");
			TNT1 A 0 A_semiflag();
			RAIL A 0 
			{
				A_overlay(-5,"DoNothing");
				A_zoomfactor(0.7);
				A_fireprojectile("shotgunparticles2",random(12,-12),false,0,0,0,random(9,-9));
				A_FireBattleRifle();
					
					A_startsound("BR45FIRE",1,0,0.85);
				
				
				
				
				A_QuadSound();
				A_ALertMonstersDX();
				A_takeammo("battlerifleammo",1);
				invoker.burstcount++;
			}
			TNT1 A 0 A_GunLight();
			BR4F A 0 A_Jump(85,3);
			BR4F B 0 A_Jump(85,2);
			BR4F C 0;
			BR4F "#" 0;
			BR4F "#" 1;
			TNT1 A 0 
			{
				A_zoomfactor(1.0);
				A_fireprojectile("riflecasespawnversion2",5,false,0,-14,0);
				If(countinv("battlerifleammo") < 1)
				{
					A_fireprojectile("RifleClipSpawn",5,false,0,-14,0);
				}
			}
			TNT1 A 0 A_jumpif(invoker.burstcount < 3,"burstfirerecoil");
			BR45 DDE 1;
			
			BR45 FGH 1;
			BR45 B 7;
			TNT1 A 0 
			{
				invoker.burstcount = 0;
			
			}
			
			TNT1 A 0 A_Semirefire("Fire","SemiAutoLul");
			TNT1 A 0 A_CheckIfAmmo("BattleRifleAmmo",1,"reload");
			
			Goto Ready;
			
			BurstFireRecoil:
			BR45 DEF 1;
			Goto Fire;
			
			SemiAutoLul:
			BR45 B 1;
			TNT1 A 0 A_Semirefire("Fire","SemiAutoLul");
			Goto Ready;
		
		
		Reload:
			TNT1 A 0 A_JumpIf(invoker.aimMode == 0, 3);
			TMT1 A 0 A_JumpIfInventory("battlerifleammo",15,"Aim");
			TNT1 A 0 A_CheckIfAmmo("clip2",1,"NoAmmo");
			Goto AimEnd;
			TNT1 A 0
			{
				invoker.semiautofired = false;
			}
			TNT1 A 0 A_takeinventory("reloading",1);
			TNT1 A 0 A_jumpifinventory("battlerifleammo",15,"ready");
			TNT1 A 0 A_CheckIfAmmo("clip2",1,"noammo");
			TNT1 A 0 A_startsound("BR45OPEN",3);
			BR4R ABCDE 1;
			TNT1 A 0
			{
			If(countinv("battlerifleammo") > 0)
				{
					A_fireprojectile("RifleClipSpawn",5,false,0,-14,0);
					A_DiscardMag("BattleRifleAmmo",0);
				}
			}
			BR4R FGGGGGGHIJKLMNOP 1;
			TNT1 A 0 
			{
				A_startsound("BR45LOAD",3);
				A_reload("battlerifleammo", 15, "clip2");
			}
			BR4R QRSTUVWX 1;
			Goto Ready;
	NoAmmo:
		TNT1 A 0 A_StartSound("weapons/empty", 3);
	NoAmmo2:
		TNT1 A 0 A_JumpIf(CountInv("Clip2") > 0 && CountInv("BattleRifleAmmo") < 15,"Reload");
		TNT1 A 0 A_JumpIf(invoker.aimMode > 0, "NoAmmo3");
		BR45 B 1 A_WeaponReady(WRF_NOFIRE);
		TNT1 A 0 A_JumpIf(player.cmd.buttons & BT_RELOAD || player.cmd.buttons & BT_ATTACK, "NoAmmo2");
		Goto Ready;
	NoAmmo3:
		BR4Z D 1 Bright A_WeaponReady(WRF_NOFIRE);
		TNT1 A 0 A_JumpIf(player.cmd.buttons & BT_RELOAD || player.cmd.buttons & BT_ATTACK, "NoAmmo2");
		Goto Aim;
	AltFire:
		BR4Z A 1
		{
			A_ZoomFactor(3.0);
			A_SetCrosshairDX("Null");
			A_StartSound("ADSIN");
		}
		BR4Z BC 1;
		TNT1 A 0 A_StartAim;
		Goto Ready;
	Aim:
		BR4Z D 1 Bright A_ReadyAim(true,true);
		Loop;
	AimEnd:
		BR4Z C 1
		{
			A_StartSound("ADSOUT");
			if(invoker.scopeZoom == true) A_ZoomFactor(3.0,ZOOM_INSTANT);
			A_ZoomFactor(1.0);
		}
        BR4Z BA 1;
		TNT1 A 0 A_SetCrosshairDX("BR45Ret",2000,0.2);
		TNT1 A 0 A_EndAim;
		Goto Ready;
	FireAim:
		TNT1 A 0 A_CheckIfAmmo("BattleRifleAmmo",1,"NoAmmo");
		TNT1 A 0 A_semiflag();
			RAIL A 0 
			{
				A_overlay(-5,"DoNothing");
				invoker.savedzoom = invoker.owner.player.fov;
				//console.printf("%i",invoker.savedzoom);
				invoker.owner.player.fov = invoker.owner.player.fov * 0.7;
				A_fireprojectile("shotgunparticles2",random(12,-12),false,0,0,0,random(9,-9));
				
					A_FireBattleRifle();
					A_startsound("BR45FIRE",1,0,0.85);
				
			
				
				//A_setpitch(pitch - 1.5);
				A_QuadSound();
				A_ALertMonstersDX();
				A_takeammo("battlerifleammo",1);
				invoker.burstcount++;
			}
			TNT1 A 0 A_GunLight();
			BR4Z D 1 BRIGHT;// A_setpitch(pitch + 0.5);
			TNT1 A 0 
			{
				invoker.owner.player.fov = invoker.savedzoom;
				A_fireprojectile("riflecasespawnversion2",5,false,15,-7,0);
				If(countinv("battlerifleammo") < 1)
				{
					A_fireprojectile("RifleClipSpawn",5,false,15,-7,0);
				}
			}
			BR4Z DD 1 BRIGHT; //A_setpitch(pitch + 0.5);
			BR4Z D 1 BRIGHT;
			TNT1 A 0 A_jumpif(invoker.burstcount < 3,"FireAim");
			BR4Z D 10 BRIGHT;
			TNT1 A 0 
			{
				invoker.burstcount = 0;
			
			}
			TNT1 A 0 A_Semirefire("FireAim","SemiAutoLulAim");
			TNT1 A 0 A_CheckIfAmmo("BattleRifleAmmo",1,"Reload");
			Goto Aim;
	SemiAutoLulAim:
		BR4Z D 1 BRIGHT;
		TNT1 A 0 A_Semirefire("FireAim","SemiAutoLulAim");
		Goto Aim;
			/*
		DualWield:
			TNT1 A 0 A_takeinventory("startdualwield",1);
			TNT1 A 0;
			BR45 B 1 A_weaponoffset(0,33);
			BR45 B 1
			{
				A_weaponoffset(0,34);
				
				A_startsound("dryfire",2);
				If(invoker.burstselected)
				{
					invoker.burstselected = false;
					A_Print("Semi Auto");
				}
				Else
				{
					invoker.burstselected = true;
					A_Print("Burst Fire");
				}
			}
			BR45 B 4;
			BR45 "#" 1 A_weaponoffset(0,33);
			BR45 "#" 1 A_weaponoffset(0,WEAPONTOP, WOF_INTERPOLATE);
			TNT1 A 0 A_takeinventory("startdualwield",1);
			Goto Ready;
			*/
			
		Spawn:
			BR45 A -1;
			LOOP;

		Unload:
			RAIL A 1 A_WeaponReady();
			RAIL A 0 A_ZoomFactor(1.0);
			RAIL A 0 A_Takeinventory("Unloading",1);
			RAIL A 0 A_Takeinventory("ADSmode",1);
			RAIL A 0 A_Takeinventory("Zoomed",1);
			RAIL A 0 A_JumpIfInventory("NuRailgunAmmo",1,1);
			Goto Ready;
		RemoveBullets:
			TNT1 A 0 A_overlay(-5,"pumpinghandlol");
			RAIL FGHI 1;
			
			RAIL JKLMNYYOO 1;
			TNT1 A 0 A_overlay(-5,"pumpinghandlol2");
			RAIL OOOO 1;
			RAIL A 0 A_JumpIfInventory("NuRailgunAmmo",1,1);
			Goto FinishUnload;
			TNT1 A 0 A_StartSound("RAILMAG2", 5);
			RAIL PR 1;
			RAIL TWWV 1;
			RAIL A 0 A_Takeinventory("NuRailgunAmmo",1);
			RAIL A 0 A_Giveinventory("AmmoCell",10);
			RAIL UUUUUUUUU/*UUUUUUUUUU*/ 1;
			TNT1 A 0 A_StartSound("RAILINSR", 5);
			RAIL UUUUUTTSRQP 1;
			Goto RemoveBullets+19;
		FinishUnload:
			TNT1 A 0 A_overlay(-5,"pumpinghandlol2reverse");
			RAIL OOOOONMLKJ 1;
			TNT1 A 0 A_overlay(-5,"pumpinghandlolreverse");
			RAIL IHGF 1;
			Goto Ready;
	}
	
}